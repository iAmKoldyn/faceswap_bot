# FaceFusion Telegram Bot (FaceSwap)

–¢–µ–ª–µ–≥—Ä–∞–º-–±–æ—Ç, –∫–æ—Ç–æ—Ä—ã–π —Å—Ç–∞–≤–∏—Ç –∑–∞–¥–∞—á–∏ –≤ FaceFusion 3.5.2, –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Ñ–æ—Ç–æ/–≤–∏–¥–µ–æ –∏ –æ—Ç–¥–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç. –†–∞–±–æ—Ç–∞–µ—Ç –≤ –ª–∏—á–∫–µ –∏ –≤ –≥—Ä—É–ø–ø–∞—Ö (inline-–∫–Ω–æ–ø–∫–∏), —Å —Ä–∞–∑–¥–µ–ª—å–Ω—ã–º–∏ –æ—á–µ—Ä–µ–¥—è–º–∏ –¥–ª—è —Ñ–æ—Ç–æ (CPU) –∏ –≤–∏–¥–µ–æ (GPU).

## –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç
1. –£—Å—Ç–∞–Ω–æ–≤–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:
   ```bash
   pip install -r requirements.txt
   ```
2. –°–æ–∑–¥–∞–π `.env` –≤ –∫–æ—Ä–Ω–µ:
   ```env
   TELEGRAM_BOT_TOKEN=xxx
   # –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ
   FACEFUSION_VIDEO_EXEC=cuda
   FACEFUSION_IMAGE_EXEC=cpu
   FACEFUSION_DIR=./facefusion-3.5.2
   ```
3. –ü—Ä–æ–≤–µ—Ä—å –ø—É—Ç–∏ –≤ `facefusion-3.5.2/facefusion.ini` (—Ä–∞–∑–¥–µ–ª `[paths]`) ‚Äî –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –ø–∞–ø–∫–∏ –Ω–∞ —É—Ä–æ–≤–µ–Ω—å –≤—ã—à–µ: `source_paths`, `target_path`, `output_path`, `jobs_path`, `temp_path`.
4. –ó–∞–ø—É—Å—Ç–∏ –±–æ—Ç–∞:
   ```bash
   python bot.py
   ```

## –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å
### –í –ª–∏—á–∫–µ
1) `/start` ‚Üí –≤—ã–±—Ä–∞—Ç—å —Ä–µ–∂–∏–º.  
2) –û—Ç–ø—Ä–∞–≤–∏—Ç—å –§–æ—Ç–æ 1 (source).  
3) –û—Ç–ø—Ä–∞–≤–∏—Ç—å target (—Ñ–æ—Ç–æ –∏–ª–∏ –≤–∏–¥–µ–æ).  
4) –î–ª—è –≤–∏–¥–µ–æ –≤ –ª–∏—á–∫–µ –±–æ—Ç —Å–ø—Ä–æ—Å–∏—Ç –∫–∞–¥—Ä (–Ω–æ–º–µ—Ä –∫–∞–¥—Ä–∞ = —Å–µ–∫—É–Ω–¥–∞ * fps) –∏–ª–∏ ¬´–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å¬ª.  
5) –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∑–∞–ø—É—Å–∫. –ü–æ–ª—É—á–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç (—Ñ–æ—Ç–æ –∏–ª–∏ –≤–∏–¥–µ–æ).

### –í –≥—Ä—É–ø–ø–µ
- –û–±—Ä–∞—â–∞–π—Å—è —á–µ—Ä–µ–∑ @ –∏–ª–∏ –ø–æ inline-–∫–Ω–æ–ø–∫–∞–º; –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ –Ω–∞–∂–∞—Ç–∏—è –º–æ–∂–Ω–æ —Å–ª–∞—Ç—å —Ñ–∞–π–ª—ã –±–µ–∑ @ (–ø–æ–∫–∞ –∞–∫—Ç–∏–≤–µ–Ω —Å–µ–∞–Ω—Å).
- –†–µ–∂–∏–º –≤—ã–±–∏—Ä–∞–µ—Ç—Å—è inline-–∫–Ω–æ–ø–∫–∞–º–∏.
- –ú–æ–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ+—Ñ–æ—Ç–æ –∏–ª–∏ —Ñ–æ—Ç–æ+–≤–∏–¥–µ–æ –æ–¥–Ω–∏–º –∞–ª—å–±–æ–º–æ–º (media group) ‚Äî –±–æ—Ç —Å–∞–º —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–∏—Ç –Ω–∞ source/target –∏ —Å—Ä–∞–∑—É –ø–æ–∫–∞–∂–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ (–∫–∞–¥—Ä –¥–ª—è –≤–∏–¥–µ–æ –≤ –≥—Ä—É–ø–ø–∞—Ö –Ω–µ —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç—Å—è).

## –†–µ–∂–∏–º—ã (–º–æ–¥–µ–ª–∏)
- üé¨ –§–æ—Ç–æ ‚Üí –í–∏–¥–µ–æ (–±—ã—Å—Ç—Ä–æ): `inswapper_128_fp16` + `gfpgan_1.4`
- üé• –§–æ—Ç–æ ‚Üí –í–∏–¥–µ–æ (–∫–∞—á–µ—Å—Ç–≤–æ): `hyperswap_1c_256` + `codeformer`
- üñºÔ∏è –§–æ—Ç–æ ‚Üí –§–æ—Ç–æ (gpen): `hyperswap_1c_256` + `gpen_bfr_1024`
- üñºÔ∏è –§–æ—Ç–æ ‚Üí –§–æ—Ç–æ (codeformer): `hyperswap_1c_256` + `codeformer`

## –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è
- –§–æ—Ä–º–∞—Ç—ã: —Ñ–æ—Ç–æ ‚Äî jpg/jpeg/png; –≤–∏–¥–µ–æ ‚Äî mp4/mov.
- –í–∏–¥–µ–æ: –¥–æ 60 –ú–ë –∏ –¥–æ 2 –º–∏–Ω—É—Ç.
- –ü–æ—Ä—è–¥–æ–∫: —Å–Ω–∞—á–∞–ª–∞ –≤—Å–µ–≥–¥–∞ –§–æ—Ç–æ 1, –∑–∞—Ç–µ–º target (—Ñ–æ—Ç–æ/–≤–∏–¥–µ–æ –ø–æ —Ä–µ–∂–∏–º—É).

## –û—á–µ—Ä–µ–¥–∏ –∏ —Ä–µ—Å—É—Ä—Å—ã
- –î–≤–µ –æ—á–µ—Ä–µ–¥–∏: –≤–∏–¥–µ–æ (GPU, `FACEFUSION_VIDEO_EXEC`, VMS –∏–∑ `FACEFUSION_VIDEO_VMS`) –∏ —Ñ–æ—Ç–æ (CPU, `FACEFUSION_IMAGE_EXEC`, VMS –∏–∑ `FACEFUSION_IMAGE_VMS`).
- FaceFusion –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ CLI job-manager (`job-create` ‚Üí `job-add-step` ‚Üí `job-submit` ‚Üí `job-run`).

## –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã
- `/start` ‚Äî –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ, –≤—ã–±–æ—Ä —Ä–µ–∂–∏–º–∞.
- `/info` ‚Äî –∫—Ä–∞—Ç–∫–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è.
- `/mode <name>` ‚Äî —Å–º–µ–Ω–∞ —Ä–µ–∂–∏–º–∞ –≤—Ä—É—á–Ω—É—é.
- `/reset` ‚Äî —Å–±—Ä–æ—Å —Ç–µ–∫—É—â–µ–π –∑–∞–≥—Ä—É–∑–∫–∏ (–æ—Ç–º–µ–Ω–∞).

## API —Å–µ—Ä–≤–µ—Ä (–¥–ª—è –º–æ–±–∏–ª—å–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è)
–õ–æ–∫–∞–ª—å–Ω—ã–π HTTP API –¥–ª—è –ø—Ä–∏—ë–º–∞ —Ñ–∞–π–ª–æ–≤, —Å–æ–∑–¥–∞–Ω–∏—è job –∏ –≤—ã–¥–∞—á–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞.

–ó–∞–ø—É—Å–∫:
```bash
python server.py
```
–ò–ª–∏ —á–µ—Ä–µ–∑ uvicorn:
```bash
uvicorn server:app --host 0.0.0.0 --port 8000
```

### –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è (JWT)
API –æ–∂–∏–¥–∞–µ—Ç –∑–∞–≥–æ–ª–æ–≤–æ–∫:
```
Authorization: Bearer <JWT>
```
–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é `JWT_REQUIRED=1`. –£–∫–∞–∂–∏ –≤ `.env`:
```env
JWT_SECRET=your_secret
JWT_ALG=HS256
JWT_REQUIRED=1
```
–¢–æ–∫–µ–Ω –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å `sub` –∏–ª–∏ `user_id`. –í—Å–µ job –ø—Ä–∏–≤—è–∑–∞–Ω—ã –∫ `owner_id`.

### Webhooks
–ú–æ–∂–Ω–æ –ø–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ —Å–æ–±—ã—Ç–∏—è job:
```
POST /jobs/{job_id}/webhook
{
  "url": "https://example.com/webhook",
  "events": ["queued", "running", "completed", "failed"]
}
```

### Token minting (manual)
Generate a JWT locally (no HTTP endpoint):
```
python -m backend.mint_token --user-id demo
```
Make sure `.env` contains:
```env
JWT_SECRET=your_secret
JWT_ALG=HS256
JWT_REQUIRED=1
```

### –ü—Ä–æ–≥—Ä–µ—Å—Å
`GET /jobs/{job_id}` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `stage` –∏ `progress` (0‚Äì100), –∫–æ—Ç–æ—Ä—ã–µ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –ø—Ä–∏ –ø–∞—Ä—Å–∏–Ω–≥–µ –ª–æ–≥–æ–≤ FaceFusion.

–ë–∞–∑–æ–≤—ã–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã:
- `POST /jobs` ‚Äî —Å–æ–∑–¥–∞—Ç—å job (body: `{ "mode": "photo_video_fast" }`)
- `POST /jobs/{job_id}/source` ‚Äî –∑–∞–≥—Ä—É–∑–∏—Ç—å source (jpg/png)
- `POST /jobs/{job_id}/target` ‚Äî –∑–∞–≥—Ä—É–∑–∏—Ç—å target (jpg/png –∏–ª–∏ mp4/mov)
- `POST /jobs/{job_id}/submit` ‚Äî –ø–æ—Å—Ç–∞–≤–∏—Ç—å –≤ –æ—á–µ—Ä–µ–¥—å
- `GET /jobs/{job_id}` ‚Äî —Å—Ç–∞—Ç—É—Å
- `GET /jobs/{job_id}/events` ‚Äî SSE stream (text/event-stream)
- `GET /jobs/{job_id}/result` ‚Äî —Å–∫–∞—á–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç
- `POST /jobs/quick` ‚Äî –±—ã—Å—Ç—Ä—ã–π –∑–∞–ø—É—Å–∫ (source+target –≤ –æ–¥–Ω–æ–º –∑–∞–ø—Ä–æ—Å–µ)

–ü—Ä–∏–º–µ—á–∞–Ω–∏—è:
- –í–∏–¥–µ–æ –¥–æ 60 –ú–ë –∏ –¥–æ 2 –º–∏–Ω—É—Ç.
- –û—á–µ—Ä–µ–¥–∏ —Ä–∞–∑–¥–µ–ª–µ–Ω—ã: –≤–∏–¥–µ–æ (GPU) –∏ —Ñ–æ—Ç–æ (CPU).
- –î–ª—è –≤–Ω–µ—à–Ω–µ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ cloudflared/ngrok –∏–ª–∏ VPN (ZeroTier).

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞
- `bot.py` ‚Äî –ª–æ–≥–∏–∫–∞ –±–æ—Ç–∞, inline/reply UI, –æ—á–µ—Ä–µ–¥–∏, –≤–∞–ª–∏–¥–∞—Ü–∏–∏.
- `server.py` ‚Äî FastAPI —Å–µ—Ä–≤–µ—Ä –¥–ª—è –º–æ–±–∏–ª—å–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.
- `facefusion-3.5.2/` ‚Äî –≤–∞–Ω–∏–ª—å–Ω–∞—è FaceFusion 3.5.2 —Å —Ñ–∏–∫—Å–∞–º–∏ (–≤ —Ç.—á. –ª–æ–∫ –ø–æ inference pool).
- –ü–∞–ø–∫–∏ –¥–∞–Ω–Ω—ã—Ö (–∏–≥–Ω–æ—Ä–∏—Ä—É—é—Ç—Å—è git): `jobs_path`, `source_paths`, `target_path`, `output_path`, `temp_path`, –∫—ç—à–∏ –º–æ–¥–µ–ª–µ–π.

## –°–æ–≤–µ—Ç—ã
- –ü–µ—Ä–µ–¥ –ø–µ—Ä–≤—ã–º –∑–∞–ø—É—Å–∫–æ–º —Å–∫–∞—á–∞–π –º–æ–¥–µ–ª–∏ FaceFusion: `python facefusion.py force-download --config-path facefusion.ini` (–∏–∑ `facefusion-3.5.2`).
- –í –≥—Ä—É–ø–ø–∞—Ö –±–æ–ª—å—à–∏–µ –≤–∏–¥–µ–æ –º–æ–≥—É—Ç –¥–æ–ª—å—à–µ ¬´–≤–∏—Å–µ—Ç—å¬ª –Ω–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏–∏; –±–æ—Ç –ø–∏—à–µ—Ç ¬´–ü–æ–ª—É—á–∞—é –≤–∏–¥–µ–æ‚Ä¶¬ª —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –ø—Ä–∏—ë–º–∞ target.
- –ï—Å–ª–∏ –º–µ–Ω—è–µ—à—å GPU/CPU ‚Äî –ø—Ä–∞–≤—å `.env` –∏–ª–∏ `execution_providers` –≤ ini, –ª–∏–±–æ –ø–µ—Ä–µ–¥–∞–≤–∞–π –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è.
